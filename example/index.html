<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My AES67 web test</title>
    <link rel="stylesheet" href="vumeter.css">
</head>
<body>
<div id="container" style="margin: 0 auto;">
    <div id=vumeter>
        <div id=left class="bar  left white"></div>
        <div id=leftlvl class="bar audio left"></div>
        <div id=leftmax class="bar max left"></div>
        <div id=graduation class="bar graduation"></div>
        <div id=right class="bar  right white"></div>
        <div id=rightlvl class="bar audio right"></div>
        <div id=rightmax class="bar max right"></div>
    </div>
</div>
<div id=button>play me</div>
<div id=data></div>
<script>

var bufferstats = [{},{},{},{}]
var bufferindex = 0

var setHeight = (a , b) => {
    let l = document.getElementById(b).getBoundingClientRect().height
    let lvl = 0
    if(a > 0)
        lvl = l
    else if(a < -90)
        lvl = 2
    else
        lvl = (((100+a)/21.5)**3 / 100 * l)
    document.getElementById(b + "lvl").style.height =  lvl + "px"
}
var setMax = (a , b) => {
    let l = document.getElementById(b).getBoundingClientRect().height
    let lvl = 0
    if(a > 0)
        lvl = l
    else if(a < -90)
        lvl = 2
    else
        lvl = (((100+a)/21.5)**3 / 100 * l)
    document.getElementById(b + "max").style.bottom = "calc(20% + " + lvl + "px)" 
}

var makeGrad = () => {
    let c = document.getElementById("graduation")
    let l = c.getBoundingClientRect().height
    let vals = [-6,-12,-24,-36,-90]
    vals.forEach(element => {
        let d = document.createElement("div")
        d.innerHTML = element
        d.className = "gradElem"
        d.style.bottom = (((100+element)/21.5)**3 / 100 * l) + "px"
        c.appendChild(d)

    });
}

 window.onload = function() {
   var socketURL = 'ws://192.168.1.162:8080';
   var socketURL2 = 'ws://192.168.1.162:8081';
   var player = new PCMPlayer({
        encoding: '32bitInt',
        channels: 2,
        sampleRate: 48000,
        flushingTime:300
   });
   let go = false

   document.getElementById("button").onclick = () => {
       go = !go
       console.log(go)
   }

   makeGrad()

   var ws = new WebSocket(socketURL);
       ws.binaryType = 'arraybuffer';
       ws.addEventListener('message',function(event) {
            var data = new Uint8Array(event.data);
            if(go)
               player.feed(data);
       });

    var ws = new WebSocket(socketURL2);
       ws.addEventListener('message',function(event) {
            document.getElementById('data').innerHTML = event.data
            let gjj = JSON.parse(event.data)
            bufferstats[bufferindex] = gjj
            bufferindex = (bufferindex + 1)%bufferstats.length
            let jj = bufferstats[(bufferindex + 2)%bufferstats.length]
            if(!jj) return
            setHeight(jj.rms[0],"left")
            setHeight(jj.rms[1],"right")
            setMax(jj.peak[0],"left")
            setMax(jj.peak[1],"right")
       });

    
   document.getElementById("data").onclick = () => {
       ws.send(JSON.stringify({type: 'clear'}))
       console.log('sending clear')
   }
 }   
</script>
<script type="text/javascript" src="../pcm-player.js"></script>
</body>
</html>
